<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madin Digital - Nurul Yusuf</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        islamic: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            500: '#10b981',
                            600: '#059669',
                            800: '#065f46',
                            900: '#064e3b',
                            gold: '#d97706'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        arabic: ['Amiri', 'serif']
                    }
                }
            }
        }
    </script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .action-col { display: none; }
        
        /* Animasi Loading */
        #loadingScreen { transition: opacity 1s ease-out, visibility 1s; }
        .fade-out { opacity: 0; visibility: hidden; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased selection:bg-islamic-500 selection:text-white">

    <div id="loadingScreen" class="fixed inset-0 z-[100] bg-black flex items-center justify-center">
        <video autoplay muted playsinline class="w-full h-full object-contain md:object-cover">
            <source src="./loading.mp4" type="video/mp4">
            Memuat Sistem...
        </video>
    </div>

    <div id="loginPage" class="fixed inset-0 z-50 flex items-center justify-center bg-islamic-50 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md mx-4 border border-islamic-100">
            <div class="text-center mb-8">
                <img src="./logo.png" alt="Logo" class="w-20 h-20 mx-auto mb-4 rounded-full shadow-md">
                <h1 class="text-2xl font-bold text-islamic-900 font-arabic">Madin Nurul Yusuf</h1>
                <p class="text-gray-500 text-sm">Sistem Manajemen Digital Pesantren</p>
            </div>

            <div class="space-y-4">
                <button onclick="handleLoginPrompt()" class="w-full flex items-center justify-between p-4 bg-islamic-600 text-white rounded-xl hover:bg-islamic-700 transition shadow-lg shadow-islamic-500/30">
                    <div class="flex items-center">
                        <i class="fas fa-user-shield text-xl mr-3"></i>
                        <div class="text-left">
                            <span class="block font-bold">Login Ustadz</span>
                            <span class="text-xs opacity-90">Akses Penuh (Edit/Input)</span>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </button>

                <button onclick="handleLogin('wali')" class="w-full flex items-center justify-between p-4 bg-white border-2 border-islamic-100 text-islamic-800 rounded-xl hover:bg-islamic-50 transition">
                    <div class="flex items-center">
                        <i class="fas fa-users text-xl mr-3 text-islamic-600"></i>
                        <div class="text-left">
                            <span class="block font-bold">Wali Santri</span>
                            <span class="text-xs text-gray-500">Mode Lihat Data</span>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-islamic-300"></i>
                </button>
            </div>

            <div class="mt-8 text-center border-t pt-4">
                <p class="text-xs text-gray-400 mb-3">&copy; 2024 Madin Digital v5.0 Pro</p>
                
                <div class="flex justify-center space-x-4">
                    <a href="https://sites.google.com/view/madin-nurulyusuf/" target="_blank" class="text-gray-400 hover:text-islamic-600 transition transform hover:scale-110">
                        <i class="fas fa-globe fa-lg"></i>
                    </a>
                    <a href="mailto:madinnurulyusuf@gmail.com" class="text-gray-400 hover:text-red-500 transition transform hover:scale-110">
                        <i class="fas fa-envelope fa-lg"></i>
                    </a>
                    <a href="https://www.instagram.com/madin.nurulyusuf?igsh=bTdwYjI4cGh6ZGNx" target="_blank" class="text-gray-400 hover:text-pink-600 transition transform hover:scale-110">
                        <i class="fab fa-instagram fa-lg"></i>
                    </a>
                    <a href="https://youtube.com/@madinnurulyusuf?si=3vzKB5zmu6kRf_eR" target="_blank" class="text-gray-400 hover:text-red-600 transition transform hover:scale-110">
                        <i class="fab fa-youtube fa-lg"></i>
                    </a>
                    <a href="https://www.tiktok.com/@madin.nurul.yusuf?_r=1&_t=ZS-93MMG32ammI" target="_blank" class="text-gray-400 hover:text-black transition transform hover:scale-110">
                        <i class="fab fa-tiktok fa-lg"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="hidden min-h-screen flex flex-col md:flex-row">
        
        <aside class="w-full md:w-64 bg-white border-r border-gray-200 flex flex-col md:h-screen sticky top-0 z-40">
            <div class="p-4 border-b border-gray-100 flex items-center space-x-3 bg-islamic-50">
                <img src="./logo.png" class="w-8 h-8 rounded-full">
                <div>
                    <h2 class="font-bold text-islamic-900 text-sm">Madin Admin</h2>
                    <p id="roleDisplay" class="text-[10px] text-islamic-600 uppercase font-bold tracking-wider">Loading...</p>
                </div>
            </div>

            <nav class="flex-1 overflow-y-auto p-2 space-y-1">
                <button onclick="switchPage('dashboard')" class="nav-item w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-islamic-50 hover:text-islamic-700 transition flex items-center">
                    <i class="fas fa-home w-8 text-center"></i> Dashboard
                </button>
                <button onclick="switchPage('absensi')" class="nav-item w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-islamic-50 hover:text-islamic-700 transition flex items-center">
                    <i class="fas fa-calendar-check w-8 text-center"></i> Absensi
                </button>
                <button onclick="switchPage('hafalan')" class="nav-item w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-islamic-50 hover:text-islamic-700 transition flex items-center">
                    <i class="fas fa-quran w-8 text-center"></i> Hafalan
                </button>
                <button onclick="switchPage('materi')" class="nav-item w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-islamic-50 hover:text-islamic-700 transition flex items-center">
                    <i class="fas fa-book w-8 text-center"></i> Materi
                </button>
                
                <div id="adminMenu" class="hidden pt-4 mt-2 border-t">
                    <p class="px-4 text-xs text-gray-400 mb-2 uppercase">Admin</p>
                    <button onclick="switchPage('dataSantri')" class="nav-item w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-islamic-50 hover:text-islamic-700 transition flex items-center">
                        <i class="fas fa-users-cog w-8 text-center"></i> Data Santri
                    </button>
                </div>
            </nav>

            <div class="p-4 border-t bg-gray-50">
                <div class="flex justify-between items-center text-xs text-gray-500 mb-3">
                    <span id="syncStatus">Check Connection...</span>
                    <span id="clock" class="font-mono">00:00</span>
                </div>
                <button onclick="location.reload()" class="w-full py-2 border border-red-200 text-red-500 rounded hover:bg-red-50 text-sm">Keluar</button>
            </div>
        </aside>

        <main class="flex-1 p-4 md:p-8 overflow-y-auto h-screen bg-gray-50">
            
            <section id="page-dashboard" class="space-y-6">
                <header class="flex justify-between items-end mb-6">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
                        <p class="text-gray-500 text-sm" id="currentDateDisplay"></p>
                    </div>
                </header>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="text-gray-500 text-xs uppercase mb-1">Total Santri</div>
                        <div class="text-2xl font-bold text-islamic-600" id="dashTotalSantri">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="text-gray-500 text-xs uppercase mb-1">Hadir Hari Ini</div>
                        <div class="text-2xl font-bold text-blue-600" id="dashHadir">0</div>
                    </div>
                </div>

                <h3 class="font-bold text-gray-700 mt-6 mb-4">Pilih Kelas</h3>
                <div id="classGrid" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </section>

            <section id="page-absensi" class="hidden space-y-4">
                <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm">
                    <div>
                        <h2 class="font-bold text-lg">Absensi</h2>
                        <p class="text-sm text-gray-500" id="absensiClassName">-</p>
                    </div>
                    <input type="date" id="absensiDate" class="border rounded px-2 py-1 text-sm">
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 border-b">
                            <tr><th class="p-4">Nama</th><th class="p-4 text-center">Status</th></tr>
                        </thead>
                        <tbody id="absensiTableBody" class="divide-y"></tbody>
                    </table>
                </div>
            </section>

            <section id="page-hafalan" class="hidden space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="font-bold text-lg">Setoran Hafalan</h2>
                    <button onclick="openHafalanModal()" class="action-col bg-islamic-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-islamic-700 shadow">
                        <i class="fas fa-plus mr-1"></i> Input
                    </button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 border-b">
                            <tr>
                                <th class="p-4">Santri</th>
                                <th class="p-4">Surah</th>
                                <th class="p-4">Catatan</th>
                                <th class="p-4 text-center action-col">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="hafalanTableBody" class="divide-y"></tbody>
                    </table>
                    <div id="hafalanEmptyState" class="hidden p-6 text-center text-gray-400 text-sm">Belum ada data.</div>
                </div>
            </section>

            <section id="page-materi" class="hidden space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="font-bold text-lg">Jurnal Materi</h2>
                    <button onclick="document.getElementById('materiModal').classList.remove('hidden')" class="action-col bg-blue-600 text-white px-4 py-2 rounded-lg text-sm shadow">
                        <i class="fas fa-pen mr-1"></i> Tulis
                    </button>
                </div>
                <div id="materiList" class="space-y-3"></div>
            </section>

            <section id="page-dataSantri" class="hidden space-y-4">
                <div class="bg-yellow-50 p-4 rounded text-sm text-yellow-700 border border-yellow-200">
                    <i class="fas fa-exclamation-triangle mr-2"></i> Edit Master Data (Format JSON)
                </div>
                <textarea id="jsonInput" class="w-full h-64 border rounded p-2 text-xs font-mono"></textarea>
                <button onclick="saveMasterData()" class="w-full bg-islamic-600 text-white py-2 rounded font-bold">Simpan Perubahan ke Server</button>
            </section>

        </main>
    </div>

    <div id="hafalanModal" class="fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold mb-4">Input Hafalan</h3>
            <div class="space-y-3">
                <select id="inputHafalanSantri" class="w-full border rounded px-3 py-2 text-sm bg-gray-50"></select>
                <input type="text" id="inputHafalanSurah" class="w-full border rounded px-3 py-2 text-sm" placeholder="Surah / Jilid">
                <textarea id="inputHafalanNote" class="w-full border rounded px-3 py-2 text-sm" placeholder="Catatan"></textarea>
                <div class="flex justify-end gap-2 mt-4">
                    <button onclick="closeHafalanModal()" class="px-3 py-2 text-gray-500 text-sm">Batal</button>
                    <button id="btnSaveHafalan" onclick="saveHafalan()" class="px-4 py-2 bg-islamic-600 text-white rounded text-sm font-bold">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <div id="materiModal" class="fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-sm p-6">
            <h3 class="font-bold mb-4">Jurnal Materi</h3>
            <div class="space-y-3">
                <input type="text" id="inputMateriJudul" class="w-full border rounded px-3 py-2" placeholder="Judul">
                <textarea id="inputMateriDesc" class="w-full border rounded px-3 py-2" rows="3" placeholder="Deskripsi"></textarea>
                <div class="flex justify-end gap-2">
                    <button onclick="document.getElementById('materiModal').classList.add('hidden')" class="px-3 py-2 text-gray-500 text-sm">Batal</button>
                    <button onclick="saveMateri()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm">Posting</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. GANTI URL INI DENGAN DEPLOYMENT ID BARU ANDA ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxQINNwOxSDs89tx_8N3vTTbBZzak4p2T_AyEyzqyOk7tt_Hyj6rBR8sS6eqeLrsNcWpw/exec'; 

        let db = { classes: [], students: [], attendanceRecap: {}, materi: [], hafalan: [] };
        let state = {
            role: null, 
            currentClassId: null,
            selectedDate: new Date().toISOString().split('T')[0],
            editingHafalanId: null // TRACKING EDIT
        };

        window.onload = function() {
            document.getElementById('currentDateDisplay').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            document.getElementById('absensiDate').value = state.selectedDate;

            // Load Cache
            const local = localStorage.getItem('pesantrenDB_v5_pro');
            if(local) db = JSON.parse(local);

            // Fetch Data
            fetch(GOOGLE_SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    db = data.data;
                    localStorage.setItem('pesantrenDB_v5_pro', JSON.stringify(db));
                    if(state.role) renderAll(); 
                }
            })
            .catch(err => console.log('Offline Mode'));
            
            setInterval(() => {
                document.getElementById('clock').innerText = new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
            }, 1000);

            // LOGIKA LOADING BARU (4 DETIK)
            setTimeout(() => {
                const screen = document.getElementById('loadingScreen');
                screen.classList.add('fade-out'); // Efek CSS
                setTimeout(() => {
                    screen.style.display = 'none';
                    document.getElementById('loginPage').classList.remove('hidden');
                    // Stop video agar ringan
                    const v = screen.querySelector('video');
                    if(v) v.pause();
                }, 1000);
            }, 3000); // 3 Detik tampil + 1 Detik fadeout = 4 Detik
        };

        // --- 2. LOGIN AMAN (SERVER SIDE) ---
        function handleLoginPrompt() {
            Swal.fire({
                title: 'Login Ustadz',
                input: 'password',
                inputPlaceholder: 'Masukkan Password',
                showCancelButton: true,
                confirmButtonText: 'Masuk',
                confirmButtonColor: '#059669',
                showLoaderOnConfirm: true,
                preConfirm: (password) => {
                    return fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'login', password: password })
                    })
                    .then(response => {
                        if (!response.ok) throw new Error(response.statusText);
                        return response.json();
                    })
                    .then(data => {
                        if (data.status !== 'success') throw new Error('Password Salah');
                        return data;
                    })
                    .catch(error => Swal.showValidationMessage(`${error}`));
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) handleLogin('ustadz');
            });
        }

        function handleLogin(role) {
            state.role = role;
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Inject CSS untuk menyembunyikan/menampilkan tombol edit
            const style = document.createElement('style');
            if (role === 'ustadz') {
                style.innerHTML = `.action-col { display: table-cell !important; }`;
                document.getElementById('roleDisplay').innerText = "USTADZ (ADMIN)";
                document.getElementById('adminMenu').classList.remove('hidden');
            } else {
                style.innerHTML = `.action-col { display: none !important; }`;
                document.getElementById('roleDisplay').innerText = "WALI SANTRI";
                document.getElementById('adminMenu').classList.add('hidden');
            }
            document.head.appendChild(style);

            renderDashboard();
        }

        // --- NAVIGATION ---
        function switchPage(pageId) {
            document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            
            if (pageId === 'dashboard') renderDashboard();
            else if (pageId === 'absensi' && state.currentClassId) renderAbsensi();
            else if (pageId === 'hafalan' && state.currentClassId) renderHafalan();
            else if (pageId === 'materi' && state.currentClassId) renderMateri();
            else if (pageId === 'dataSantri') document.getElementById('jsonInput').value = JSON.stringify({classes: db.classes, students: db.students}, null, 2);
        }

        function renderDashboard() {
            document.getElementById('dashTotalSantri').innerText = db.students.length;
            const grid = document.getElementById('classGrid');
            grid.innerHTML = '';
            db.classes.forEach(c => {
                const count = db.students.filter(s => s.classId == c.id).length;
                grid.innerHTML += `
                    <div onclick="selectClass('${c.id}', '${c.name}')" class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md cursor-pointer transition">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-gray-800">${c.name}</h3>
                            <span class="bg-islamic-50 text-islamic-700 text-xs px-2 py-1 rounded font-bold">${c.level}</span>
                        </div>
                        <p class="text-xs text-gray-500">${count} Santri</p>
                    </div>
                `;
            });
        }

        function selectClass(id, name) {
            state.currentClassId = id;
            document.getElementById('absensiClassName').innerText = name;
            switchPage('absensi');
        }

        function renderAbsensi() {
            const tb = document.getElementById('absensiTableBody');
            tb.innerHTML = '';
            const list = db.students.filter(s => s.classId === state.currentClassId);
            list.forEach(s => {
                const status = (s.attendance && s.attendance[state.selectedDate]) ? s.attendance[state.selectedDate] : '-';
                let content = '';
                
                if(state.role === 'ustadz') {
                    content = `
                        <div class="flex space-x-1 justify-center">
                            <button onclick="setAbsen('${s.id}','H')" class="w-8 h-8 rounded ${status=='H'?'bg-green-500 text-white':'bg-gray-100 text-gray-400'} font-bold">H</button>
                            <button onclick="setAbsen('${s.id}','I')" class="w-8 h-8 rounded ${status=='I'?'bg-blue-500 text-white':'bg-gray-100 text-gray-400'} font-bold">I</button>
                            <button onclick="setAbsen('${s.id}','S')" class="w-8 h-8 rounded ${status=='S'?'bg-yellow-500 text-white':'bg-gray-100 text-gray-400'} font-bold">S</button>
                            <button onclick="setAbsen('${s.id}','A')" class="w-8 h-8 rounded ${status=='A'?'bg-red-500 text-white':'bg-gray-100 text-gray-400'} font-bold">A</button>
                        </div>
                    `;
                } else {
                    const color = {H:'green', I:'blue', S:'yellow', A:'red', '-': 'gray'}[status];
                    content = `<span class="px-2 py-1 bg-${color}-100 text-${color}-600 rounded text-xs font-bold">${status}</span>`;
                }
                
                tb.innerHTML += `<tr class="hover:bg-gray-50"><td class="p-4 font-medium">${s.name}</td><td class="p-4 text-center">${content}</td></tr>`;
            });
        }

        function setAbsen(id, val) {
            const s = db.students.find(x => x.id == id);
            if(!s.attendance) s.attendance = {};
            s.attendance[state.selectedDate] = val;
            renderAbsensi();
            sendData({ action: 'updateAttendance', studentId: id, date: state.selectedDate, status: val });
        }

        // --- 3. FIX HAFALAN (EDIT & DELETE) ---
        function renderHafalan() {
            const tb = document.getElementById('hafalanTableBody'); tb.innerHTML = '';
            const ids = db.students.filter(s => s.classId === state.currentClassId).map(s => s.id);
            const list = db.hafalan.filter(h => ids.includes(h.studentId) && h.date === state.selectedDate);
            
            document.getElementById('hafalanEmptyState').classList.toggle('hidden', list.length > 0);
            
            list.forEach(h => {
                const sName = db.students.find(s => s.id == h.studentId)?.name || 'Unknown';
                // FIX: Menambahkan tanda kutip '' pada ID agar dibaca string
                const editBtn = `<button onclick="prepareEditHafalan('${h.id}')" class="text-blue-500 p-2 hover:bg-blue-50 rounded"><i class="fas fa-pen"></i></button>`;
                const delBtn = `<button onclick="delHaf('${h.id}')" class="text-red-500 p-2 hover:bg-red-50 rounded"><i class="fas fa-trash"></i></button>`;
                
                tb.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="p-4 font-bold text-gray-700">${sName}</td>
                        <td class="p-4 text-islamic-800 font-arabic text-lg">${h.surah}</td>
                        <td class="p-4 text-gray-500 italic">${h.note}</td>
                        <td class="p-4 text-center action-col space-x-1">${editBtn}${delBtn}</td>
                    </tr>`;
            });
        }

        function openHafalanModal() {
            state.editingHafalanId = null; // Reset Mode Edit
            document.getElementById('btnSaveHafalan').innerText = "Simpan";
            document.getElementById('inputHafalanSurah').value = '';
            document.getElementById('inputHafalanNote').value = '';
            
            const sel = document.getElementById('inputHafalanSantri'); sel.innerHTML = '';
            sel.disabled = false;
            db.students.filter(s => s.classId === state.currentClassId).forEach(s => {
                sel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });
            document.getElementById('hafalanModal').classList.remove('hidden');
        }

        function closeHafalanModal() {
            document.getElementById('hafalanModal').classList.add('hidden');
        }

        function prepareEditHafalan(id) {
            const h = db.hafalan.find(item => String(item.id) === String(id));
            if(!h) return;

            state.editingHafalanId = id; // Set ID yang diedit
            
            const sel = document.getElementById('inputHafalanSantri'); sel.innerHTML = '';
            const sName = db.students.find(s => s.id == h.studentId)?.name;
            sel.innerHTML = `<option value="${h.studentId}">${sName}</option>`;
            sel.disabled = true; // Kunci nama santri

            document.getElementById('inputHafalanSurah').value = h.surah;
            document.getElementById('inputHafalanNote').value = h.note;
            document.getElementById('btnSaveHafalan').innerText = "Update";
            
            document.getElementById('hafalanModal').classList.remove('hidden');
        }

        function saveHafalan() {
            const sId = document.getElementById('inputHafalanSantri').value;
            const surah = document.getElementById('inputHafalanSurah').value;
            const note = document.getElementById('inputHafalanNote').value;

            if(state.editingHafalanId) {
                // LOGIKA EDIT
                const idx = db.hafalan.findIndex(h => String(h.id) === String(state.editingHafalanId));
                if(idx !== -1) {
                    db.hafalan[idx].surah = surah;
                    db.hafalan[idx].note = note;
                }
                sendData({ action: 'editHafalan', id: state.editingHafalanId, surah: surah, note: note });
            } else {
                // LOGIKA BARU
                const newItem = { id: 'haf_'+Date.now(), studentId: sId, date: state.selectedDate, surah: surah, note: note };
                db.hafalan.push(newItem);
                sendData({ action: 'addHafalan', ...newItem });
            }
            closeHafalanModal();
            renderHafalan();
        }

        function delHaf(id) {
            if(confirm('Hapus hafalan ini?')) {
                db.hafalan = db.hafalan.filter(h => String(h.id) !== String(id));
                renderHafalan();
                sendData({ action: 'deleteHafalan', id: id });
            }
        }

        // --- MATERI ---
        function renderMateri() {
            const list = document.getElementById('materiList'); list.innerHTML = '';
            db.materi.filter(m => m.classId === state.currentClassId).forEach(m => {
                list.innerHTML += `
                    <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500 shadow-sm">
                        <div class="flex justify-between"><h4 class="font-bold">${m.title}</h4><span class="text-xs text-gray-400">${m.date}</span></div>
                        <p class="text-sm text-gray-600 mt-1">${m.desc}</p>
                    </div>`;
            });
        }
        function saveMateri() {
            const title = document.getElementById('inputMateriJudul').value;
            const desc = document.getElementById('inputMateriDesc').value;
            const item = { id: 'mat_'+Date.now(), classId: state.currentClassId, date: state.selectedDate, title: title, desc: desc };
            db.materi.unshift(item);
            document.getElementById('materiModal').classList.add('hidden');
            renderMateri();
            sendData({ action: 'addMateri', ...item });
        }

        function saveMasterData() {
            try {
                const parsed = JSON.parse(document.getElementById('jsonInput').value);
                db.classes = parsed.classes; db.students = parsed.students;
                localStorage.setItem('pesantrenDB_v5_pro', JSON.stringify(db));
                sendData({ action: 'syncMaster', classes: db.classes, students: db.students });
                alert('Data Tersimpan!');
            } catch(e) { alert('Format JSON Salah'); }
        }

        function sendData(payload) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.innerText = 'Syncing...';
            statusEl.className = 'text-blue-500';
            
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(d => {
                statusEl.innerText = 'Online';
                statusEl.className = 'text-green-500';
            })
            .catch(e => {
                statusEl.innerText = 'Offline (Saved Locally)';
                statusEl.className = 'text-orange-500';
                localStorage.setItem('pesantrenDB_v5_pro', JSON.stringify(db));
            });
        }
    </script>
</body>
</html>
