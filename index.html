<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madin Digital - Nurul Yusuf</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        islamic: {
                            50: '#f2f8f6',
                            100: '#e1efeb',
                            500: '#10b981', // Emerald
                            600: '#059669',
                            800: '#065f46',
                            900: '#064e3b',
                            gold: '#fbbf24'
                        }
                    },
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        arabic: ['Amiri', 'serif']
                    }
                }
            }
        }
    </script>

    <style>
        /* Glassmorphism & Animations */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .glass-dark {
            background: rgba(6, 78, 59, 0.95);
            backdrop-filter: blur(10px);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
        
        /* Loading Animation */
        .loader {
            border-top-color: #10b981;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Table */
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
        }

        /* Action Column Logic */
        .action-col { display: none; }
    </style>
</head>
<body class="bg-islamic-50 text-gray-800 antialiased selection:bg-islamic-500 selection:text-white overflow-hidden">

    <div id="loadingScreen" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center transition-opacity duration-1000">
        <div class="relative w-full h-full max-w-md md:max-w-2xl aspect-[9/16] md:aspect-video bg-black">
            <video id="loadingVideo" autoplay muted playsinline class="w-full h-full object-contain">
                <source src="./loading.mp4" type="video/mp4">
                Browser Anda tidak mendukung tag video.
            </video>
            <div class="absolute bottom-10 w-full text-center text-white/80 text-sm animate-pulse">
                Memuat Sistem Madin Digital...
            </div>
        </div>
    </div>

    <div id="loginPage" class="fixed inset-0 z-50 flex items-center justify-center bg-[url('https://images.unsplash.com/photo-1596920395724-4f0e470b1062?q=80&w=2070&auto=format&fit=crop')] bg-cover bg-center hidden">
        <div class="absolute inset-0 bg-islamic-900/80 backdrop-blur-sm"></div>
        
        <div class="relative w-full max-w-md p-8 mx-4 glass rounded-3xl shadow-2xl transform transition-all duration-500 hover:scale-[1.01]">
            <div class="text-center mb-8">
                <img src="./logo.png" alt="Logo" class="w-24 h-24 mx-auto mb-4 drop-shadow-lg rounded-full bg-white p-2">
                <h1 class="text-3xl font-bold text-islamic-900 font-arabic mb-1">Madin Nurul Yusuf</h1>
                <p class="text-gray-500 text-sm">Sistem Manajemen Digital Pesantren</p>
            </div>

            <div class="space-y-4">
                <button onclick="handleLogin('ustadz')" class="w-full group relative px-6 py-4 bg-gradient-to-r from-islamic-600 to-islamic-500 text-white rounded-xl shadow-lg hover:shadow-islamic-500/30 transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 bg-white/20 rounded-lg group-hover:bg-white/30 transition">
                                <i class="fas fa-user-tie text-xl"></i>
                            </div>
                            <div class="text-left">
                                <span class="block font-bold text-lg">Login Ustadz</span>
                                <span class="text-xs text-islamic-100 opacity-80">Akses Penuh (Edit/Input)</span>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right opacity-0 group-hover:opacity-100 transform translate-x-[-10px] group-hover:translate-x-0 transition-all"></i>
                    </div>
                </button>

                <button onclick="handleLogin('wali')" class="w-full group relative px-6 py-4 bg-white border-2 border-islamic-100 text-islamic-800 rounded-xl hover:bg-islamic-50 transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 bg-islamic-100 rounded-lg group-hover:bg-white transition">
                                <i class="fas fa-users text-xl text-islamic-600"></i>
                            </div>
                            <div class="text-left">
                                <span class="block font-bold text-lg">Wali Santri</span>
                                <span class="text-xs text-gray-500">Mode Lihat Data (Read Only)</span>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-islamic-300 group-hover:text-islamic-600"></i>
                    </div>
                </button>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-100 text-center">
                <p class="text-xs text-gray-400 mb-3">&copy; 2024 Madin Digital v5.0 Pro</p>
                
                <div class="flex justify-center space-x-5">
                    <a href="https://sites.google.com/view/madin-nurulyusuf/" target="_blank" class="text-gray-400 hover:text-islamic-600 transition transform hover:scale-110" title="Website">
                        <i class="fas fa-globe fa-lg"></i>
                    </a>
                    <a href="mailto:madinnurulyusuf@gmail.com" class="text-gray-400 hover:text-red-500 transition transform hover:scale-110" title="Email">
                        <i class="fas fa-envelope fa-lg"></i>
                    </a>
                    <a href="https://www.instagram.com/madin.nurulyusuf?igsh=bTdwYjI4cGh6ZGNx" target="_blank" class="text-gray-400 hover:text-pink-600 transition transform hover:scale-110" title="Instagram">
                        <i class="fab fa-instagram fa-lg"></i>
                    </a>
                    <a href="https://youtube.com/@madinnurulyusuf?si=3vzKB5zmu6kRf_eR" target="_blank" class="text-gray-400 hover:text-red-600 transition transform hover:scale-110" title="YouTube">
                        <i class="fab fa-youtube fa-lg"></i>
                    </a>
                    <a href="https://www.tiktok.com/@madin.nurul.yusuf?_r=1&_t=ZS-93MMG32ammI" target="_blank" class="text-gray-400 hover:text-black transition transform hover:scale-110" title="TikTok">
                        <i class="fab fa-tiktok fa-lg"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="hidden h-screen flex flex-col md:flex-row bg-islamic-50">
        
        <aside class="md:w-64 bg-white border-r border-gray-200 flex flex-col shadow-lg z-20">
            <div class="p-6 border-b border-gray-100 flex items-center space-x-3 bg-islamic-50">
                <img src="./logo.png" class="w-10 h-10 rounded-full bg-white p-1 shadow-sm">
                <div>
                    <h2 class="font-bold text-islamic-800">Madin Admin</h2>
                    <p id="roleDisplay" class="text-xs text-islamic-500 font-semibold uppercase tracking-wider">Loading...</p>
                </div>
            </div>

            <nav class="flex-1 overflow-y-auto p-4 space-y-2">
                <button onclick="switchPage('dashboard')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-islamic-50 hover:text-islamic-700 transition active-nav">
                    <i class="fas fa-th-large w-6"></i>
                    <span class="font-medium">Dashboard</span>
                </button>
                <button onclick="switchPage('absensi')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-islamic-50 hover:text-islamic-700 transition">
                    <i class="fas fa-calendar-check w-6"></i>
                    <span class="font-medium">Absensi Harian</span>
                </button>
                <button onclick="switchPage('hafalan')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-islamic-50 hover:text-islamic-700 transition">
                    <i class="fas fa-quran w-6"></i>
                    <span class="font-medium">Setoran Hafalan</span>
                </button>
                <button onclick="switchPage('materi')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-islamic-50 hover:text-islamic-700 transition">
                    <i class="fas fa-book-open w-6"></i>
                    <span class="font-medium">Jurnal Materi</span>
                </button>
                
                <div id="adminMenu" class="hidden pt-4 mt-4 border-t border-gray-100">
                    <p class="px-4 text-xs font-bold text-gray-400 uppercase mb-2">Manajemen</p>
                    <button onclick="switchPage('dataSantri')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-islamic-50 hover:text-islamic-700 transition">
                        <i class="fas fa-users-cog w-6"></i>
                        <span class="font-medium">Data Santri</span>
                    </button>
                </div>
            </nav>

            <div class="p-4 border-t border-gray-100 bg-gray-50">
                <div class="flex items-center justify-between mb-3">
                    <div class="text-xs text-gray-500" id="syncStatus">
                        <i class="fas fa-circle text-green-500 mr-1"></i> Online
                    </div>
                    <div class="text-xs font-mono text-gray-400" id="clock">00:00</div>
                </div>
                <button onclick="logout()" class="w-full flex items-center justify-center space-x-2 bg-white border border-red-200 text-red-500 py-2 rounded-lg hover:bg-red-50 transition text-sm font-medium">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Keluar</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full overflow-hidden relative">
            <header class="md:hidden bg-white h-16 flex items-center justify-between px-4 shadow-sm z-10">
                <div class="flex items-center space-x-3">
                    <img src="./logo.png" class="w-8 h-8">
                    <span class="font-bold text-islamic-800">Madin Digital</span>
                </div>
                <button onclick="document.querySelector('aside').classList.toggle('-translate-x-full'); document.querySelector('aside').classList.toggle('absolute');" class="text-gray-600">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </header>

            <div id="contentArea" class="flex-1 overflow-y-auto p-4 md:p-8 pb-24">
                
                <section id="page-dashboard" class="space-y-6">
                    <div class="flex justify-between items-end">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Assalamu'alaikum,</h1>
                            <p class="text-gray-500">Ringkasan aktivitas Madin hari ini.</p>
                        </div>
                        <div class="hidden md:block">
                            <span class="bg-islamic-100 text-islamic-700 px-4 py-2 rounded-full text-sm font-semibold">
                                <i class="far fa-calendar-alt mr-2"></i> <span id="currentDateDisplay"></span>
                            </span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gradient-to-br from-islamic-500 to-islamic-600 rounded-2xl p-6 text-white shadow-lg shadow-islamic-500/20">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-islamic-100 text-sm font-medium mb-1">Total Santri</p>
                                    <h3 class="text-3xl font-bold" id="dashTotalSantri">0</h3>
                                </div>
                                <div class="p-3 bg-white/20 rounded-xl backdrop-blur-sm">
                                    <i class="fas fa-user-graduate text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-400 text-sm font-medium mb-1">Kehadiran Hari Ini</p>
                                    <h3 class="text-3xl font-bold text-gray-800" id="dashHadir">0%</h3>
                                </div>
                                <div class="p-3 bg-blue-50 text-blue-500 rounded-xl">
                                    <i class="fas fa-chart-pie text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-400 text-sm font-medium mb-1">Setoran Hafalan</p>
                                    <h3 class="text-3xl font-bold text-gray-800" id="dashHafalan">0</h3>
                                </div>
                                <div class="p-3 bg-orange-50 text-orange-500 rounded-xl">
                                    <i class="fas fa-star text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-lg font-bold text-gray-700 mt-8">Pilih Kelas</h3>
                    <div id="classGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        </div>
                </section>

                <section id="page-absensi" class="hidden space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sticky top-0 z-10">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-calendar-check text-islamic-500 mr-2"></i> Absensi Kelas
                                </h2>
                                <p class="text-sm text-gray-500" id="absensiClassName">-</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="date" id="absensiDate" class="border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-islamic-500 outline-none">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-gray-500 text-sm uppercase">
                                <tr>
                                    <th class="px-6 py-4">Nama Santri</th>
                                    <th class="px-6 py-4 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="absensiTableBody" class="divide-y divide-gray-100">
                                </tbody>
                        </table>
                        <div id="absensiEmptyState" class="hidden p-8 text-center text-gray-400">
                            <i class="fas fa-inbox text-4xl mb-2"></i>
                            <p>Tidak ada data siswa di kelas ini.</p>
                        </div>
                    </div>
                </section>

                <section id="page-hafalan" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-800">Setoran Hafalan</h2>
                        <button onclick="openHafalanModal()" class="action-col bg-islamic-500 hover:bg-islamic-600 text-white px-4 py-2 rounded-lg shadow-lg shadow-islamic-500/30 transition flex items-center">
                            <i class="fas fa-plus mr-2"></i> Input
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-gray-500 text-sm uppercase">
                                <tr>
                                    <th class="px-6 py-4">Santri</th>
                                    <th class="px-6 py-4">Surah/Jilid</th>
                                    <th class="px-6 py-4">Catatan</th>
                                    <th class="px-6 py-4 text-center action-col">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="hafalanTableBody" class="divide-y divide-gray-100 text-sm"></tbody>
                        </table>
                        <div id="hafalanEmptyState" class="hidden p-8 text-center text-gray-400">
                            <p>Belum ada setoran hari ini.</p>
                        </div>
                    </div>
                </section>

                <section id="page-materi" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-800">Jurnal Materi</h2>
                        <button onclick="document.getElementById('materiModal').classList.remove('hidden')" class="action-col bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg shadow transition">
                            <i class="fas fa-pen-fancy mr-2"></i> Tulis Jurnal
                        </button>
                    </div>

                    <div id="materiList" class="space-y-4">
                        </div>
                </section>

                <section id="page-dataSantri" class="hidden space-y-6">
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-yellow-700">
                                    Perubahan data santri disini akan disinkronkan ke server. Hati-hati saat mengubah Kelas ID.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <textarea id="jsonInput" class="w-full h-40 border rounded-lg p-3 font-mono text-xs" placeholder='Paste JSON format: {"classes": [...], "students": [...]}'></textarea>
                    </div>
                    <button onclick="saveMasterData()" class="bg-islamic-600 text-white px-6 py-2 rounded-lg hover:bg-islamic-700 w-full font-bold">
                        <i class="fas fa-save mr-2"></i> Simpan Perubahan ke Server
                    </button>
                </section>
            </div>
        </main>
    </div>

    <div id="hafalanModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl animate-fade-in-up">
            <h3 class="text-lg font-bold mb-4 text-gray-800">Input Hafalan</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Santri</label>
                    <select id="inputHafalanSantri" class="w-full border rounded-lg px-3 py-2 bg-gray-50 focus:bg-white transition"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Surah / Pencapaian</label>
                    <input type="text" id="inputHafalanSurah" class="w-full border rounded-lg px-3 py-2" placeholder="Contoh: An-Naba Ayat 1-10">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Catatan / Nilai</label>
                    <textarea id="inputHafalanNote" class="w-full border rounded-lg px-3 py-2" rows="2" placeholder="Lancar / Perlu diulang"></textarea>
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button onclick="closeHafalanModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">Batal</button>
                    <button id="btnSaveHafalan" onclick="saveHafalan()" class="px-4 py-2 bg-islamic-500 text-white rounded-lg hover:bg-islamic-600 shadow-lg shadow-islamic-500/30">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <div id="materiModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-gray-800">Jurnal Materi</h3>
            <div class="space-y-4">
                <input type="text" id="inputMateriJudul" class="w-full border rounded-lg px-3 py-2 font-bold" placeholder="Judul Materi / Kitab">
                <textarea id="inputMateriDesc" class="w-full border rounded-lg px-3 py-2" rows="4" placeholder="Ringkasan materi yang diajarkan..."></textarea>
                <div class="flex justify-end space-x-2">
                    <button onclick="document.getElementById('materiModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">Batal</button>
                    <button onclick="saveMateri()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 shadow-lg shadow-blue-500/30">Posting</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // GANTI URL INI DENGAN DEPLOYMENT ID GOOGLE SCRIPT ANDA YANG TERBARU
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxQINNwOxSDs89tx_8N3vTTbBZzak4p2T_AyEyzqyOk7tt_Hyj6rBR8sS6eqeLrsNcWpw/exec'; 
        
        // State Management
        let db = { classes: [], students: [], attendanceRecap: {}, materi: [], hafalan: [] };
        let state = {
            role: null, // 'ustadz' | 'wali'
            currentClassId: null,
            selectedDate: new Date().toISOString().split('T')[0],
            isOnline: navigator.onLine,
            editingHafalanId: null // Untuk melacak ID hafalan yang sedang diedit
        };

        // --- CORE FUNCTIONS ---

        window.onload = function() {
            // Update UI Date
            document.getElementById('currentDateDisplay').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('absensiDate').value = state.selectedDate;

            // Offline Check
            window.addEventListener('online', () => updateStatus(true));
            window.addEventListener('offline', () => updateStatus(false));

            // Load Local Data First
            const local = localStorage.getItem('pesantrenDB_v6_pro'); // Bump version to clear old cache
            if(local) {
                db = JSON.parse(local);
                console.log("Local Data Loaded");
            }

            // Fetch Online Data (Background Sync)
            fetch(GOOGLE_SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    db = data.data;
                    localStorage.setItem('pesantrenDB_v6_pro', JSON.stringify(db));
                    console.log("Cloud Data Synced");
                    // Jika sudah login, refresh tampilan
                    if(state.role) renderAll();
                }
            })
            .catch(err => {
                console.warn('Sync Failed, using local:', err);
                updateStatus(false);
            });

            // Start Loading Sequence (4 Seconds)
            setTimeout(() => {
                finishLoadingSequence();
            }, 3000); // 3 detik loading + 1 detik animasi fadeout = 4 detik total
            
            // Start Clock
            setInterval(updateClock, 1000);
        };

        function finishLoadingSequence() {
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.classList.add('opacity-0'); // Fade out CSS
            
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
                
                // Stop Video to save memory
                const vid = loadingScreen.querySelector('video');
                if(vid) vid.pause();
            }, 1000); // Wait for transition
        }

        // --- AUTH & ROLES (SERVER SIDE LOGIN) ---

        function handleLogin(role) {
            state.role = role;

            if (role === 'ustadz') {
                // Gunakan SweetAlert untuk input password
                Swal.fire({
                    title: 'Login Ustadz',
                    input: 'password',
                    inputPlaceholder: 'Masukkan Password',
                    showCancelButton: true,
                    confirmButtonText: 'Login',
                    confirmButtonColor: '#10b981',
                    showLoaderOnConfirm: true,
                    preConfirm: (password) => {
                        return fetch(GOOGLE_SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'login', password: password })
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(response.statusText)
                            }
                            return response.json()
                        })
                        .then(data => {
                            if (data.status === 'error') {
                                Swal.showValidationMessage(`Password Salah!`)
                            }
                            return data
                        })
                        .catch(error => {
                            Swal.showValidationMessage(`Request failed: ${error}`)
                        })
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                }).then((result) => {
                    if (result.isConfirmed) {
                        finalizeLogin('ustadz');
                    }
                })
            } else {
                // Wali Santri (Tanpa Password)
                finalizeLogin('wali');
            }
        }

        function finalizeLogin(role) {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Apply Role UI
            const styles = document.createElement('style');
            if (role === 'ustadz') {
                styles.innerHTML = `.action-col { display: table-cell; }`;
                document.getElementById('roleDisplay').textContent = "USTADZ (ADMIN)";
                document.getElementById('adminMenu').classList.remove('hidden');
            } else {
                styles.innerHTML = `.action-col { display: none !important; }`;
                document.getElementById('roleDisplay').textContent = "WALI SANTRI";
                document.getElementById('adminMenu').classList.add('hidden');
            }
            document.head.appendChild(styles);

            renderDashboard();
        }

        function logout() {
            localStorage.removeItem('pesantrenDB_v6_pro'); // Clear cache on logout optional
            location.reload();
        }

        // --- NAVIGATION ---
        function switchPage(pageId) {
            document.querySelectorAll('main > div > section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('bg-islamic-50', 'text-islamic-700'));
            event.currentTarget.classList.add('bg-islamic-50', 'text-islamic-700');
            
            if (pageId === 'dashboard') renderDashboard();
            else if (pageId === 'absensi' && state.currentClassId) renderAbsensi();
            else if (pageId === 'hafalan' && state.currentClassId) renderHafalan();
            else if (pageId === 'materi' && state.currentClassId) renderMateri();
        }

        // --- RENDER FUNCTIONS ---

        function renderDashboard() {
            // Stats
            document.getElementById('dashTotalSantri').innerText = db.students.length;
            // Hitung % Kehadiran Hari Ini
            const todayLog = db.attendanceRecap ? Object.values(db.attendanceRecap).reduce((acc, curr) => acc + (curr.H || 0), 0) : 0; 
            // Simple logic placeholder, real implementation needs filtering by date from raw logs if available locally
            document.getElementById('dashHadir').innerText = (todayLog > 0) ? "Active" : "Wait"; 
            document.getElementById('dashHafalan').innerText = db.hafalan.filter(h => h.date === state.selectedDate).length;

            const grid = document.getElementById('classGrid');
            grid.innerHTML = '';
            
            if (!db.classes || db.classes.length === 0) {
                grid.innerHTML = '<p class="text-gray-500">Belum ada data kelas.</p>';
                return;
            }

            db.classes.forEach(c => {
                grid.innerHTML += `
                    <div onclick="selectClass('${c.id}', '${c.name}')" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-lg hover:border-islamic-200 cursor-pointer transition transform hover:-translate-y-1 group">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-gray-800 group-hover:text-islamic-600 transition">${c.name}</h3>
                            <span class="bg-islamic-50 text-islamic-600 text-xs px-2 py-1 rounded-lg font-bold">${c.level}</span>
                        </div>
                        <div class="flex items-center justify-between text-sm text-gray-500">
                            <span><i class="fas fa-user-graduate mr-2"></i> ${db.students.filter(s => s.classId == c.id).length} Santri</span>
                            <i class="fas fa-arrow-right opacity-0 group-hover:opacity-100 transition text-islamic-500"></i>
                        </div>
                    </div>
                `;
            });
        }

        function selectClass(id, name) {
            state.currentClassId = id;
            document.getElementById('absensiClassName').innerText = name;
            switchPage('absensi');
            renderAbsensi();
        }

        function renderAbsensi() {
            const tb = document.getElementById('absensiTableBody');
            tb.innerHTML = '';
            const students = db.students.filter(s => s.classId === state.currentClassId);
            
            if (students.length === 0) {
                document.getElementById('absensiEmptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('absensiEmptyState').classList.add('hidden');

            students.forEach(s => {
                const status = (s.attendance && s.attendance[state.selectedDate]) ? s.attendance[state.selectedDate] : '-';
                // Button Logic for Ustadz
                let actions = '';
                if(state.role === 'ustadz') {
                    actions = `
                        <div class="flex justify-center space-x-1">
                            <button onclick="setAbsen('${s.id}', 'H')" class="${status==='H'?'bg-green-500 text-white':'bg-gray-100 text-gray-400'} p-2 rounded-lg hover:bg-green-600 transition">H</button>
                            <button onclick="setAbsen('${s.id}', 'I')" class="${status==='I'?'bg-blue-500 text-white':'bg-gray-100 text-gray-400'} p-2 rounded-lg hover:bg-blue-600 transition">I</button>
                            <button onclick="setAbsen('${s.id}', 'S')" class="${status==='S'?'bg-yellow-500 text-white':'bg-gray-100 text-gray-400'} p-2 rounded-lg hover:bg-yellow-600 transition">S</button>
                            <button onclick="setAbsen('${s.id}', 'A')" class="${status==='A'?'bg-red-500 text-white':'bg-gray-100 text-gray-400'} p-2 rounded-lg hover:bg-red-600 transition">A</button>
                        </div>
                    `;
                } else {
                    const badgeColor = {'H':'green','I':'blue','S':'yellow','A':'red','-':'gray'}[status];
                    actions = `<span class="px-3 py-1 rounded-full text-xs font-bold bg-${badgeColor}-100 text-${badgeColor}-600">${status === '-' ? 'Belum Absen' : status}</span>`;
                }

                tb.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b border-gray-50 transition">
                        <td class="px-6 py-4 font-medium text-gray-700">${s.name}</td>
                        <td class="px-6 py-4 text-center">${actions}</td>
                    </tr>
                `;
            });
        }

        function setAbsen(sId, status) {
            // Update Local
            const sIdx = db.students.findIndex(s => s.id == sId);
            if (!db.students[sIdx].attendance) db.students[sIdx].attendance = {};
            db.students[sIdx].attendance[state.selectedDate] = status;
            
            renderAbsensi(); // Re-render UI immediately

            // Send to Server
            sendData({
                action: 'updateAttendance',
                studentId: sId,
                date: state.selectedDate,
                status: status
            });
        }

        // --- HAFALAN LOGIC (FIXED) ---

        function renderHafalan() {
            const tb = document.getElementById('hafalanTableBody');
            tb.innerHTML = '';
            
            // Filter Hafalan berdasarkan Kelas & Tanggal
            const classStudentIds = db.students.filter(s => s.classId === state.currentClassId).map(s => s.id);
            const list = db.hafalan.filter(h => classStudentIds.includes(h.studentId) && h.date === state.selectedDate);
            
            if (list.length === 0) {
                document.getElementById('hafalanEmptyState').classList.remove('hidden');
            } else {
                document.getElementById('hafalanEmptyState').classList.add('hidden');
            }

            list.forEach(h => {
                const sName = db.students.find(s => s.id == h.studentId)?.name || 'Unknown';
                
                // --- PERBAIKAN TOMBOL EDIT & HAPUS ---
                // Menggunakan ID sebagai string dengan tanda kutip ('${h.id}')
                const editBtn = `
                    <button onclick="prepareEditHafalan('${h.id}')" class="text-blue-500 hover:text-blue-700 p-2 bg-blue-50 rounded-lg transition" title="Edit">
                        <i class="fas fa-pen"></i>
                    </button>
                `;
                const delBtn = `
                    <button onclick="delHaf('${h.id}')" class="text-red-500 hover:text-red-700 p-2 bg-red-50 rounded-lg transition" title="Hapus">
                        <i class="fas fa-trash"></i>
                    </button>
                `;

                tb.innerHTML += `
                    <tr class="hover:bg-green-50/30 border-b border-green-50 transition">
                        <td class="px-6 py-4 font-bold text-gray-800">${sName}</td>
                        <td class="px-6 py-4 text-islamic-800 font-semibold font-arabic text-lg">${h.surah}</td>
                        <td class="px-6 py-4 text-gray-600 italic text-sm">${h.note}</td>
                        <td class="px-6 py-4 text-center action-col space-x-2">
                            ${editBtn}
                            ${delBtn}
                        </td>
                    </tr>
                `;
            });
        }

        function openHafalanModal() {
            // Reset Form untuk Input Baru
            state.editingHafalanId = null; 
            document.getElementById('btnSaveHafalan').innerText = "Simpan";
            document.getElementById('inputHafalanSurah').value = '';
            document.getElementById('inputHafalanNote').value = '';

            // Isi Dropdown Siswa
            const sel = document.getElementById('inputHafalanSantri');
            sel.innerHTML = '';
            db.students.filter(s => s.classId === state.currentClassId).forEach(s => {
                sel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });
            
            document.getElementById('hafalanModal').classList.remove('hidden');
        }
        
        function closeHafalanModal() {
            document.getElementById('hafalanModal').classList.add('hidden');
        }

        // --- FUNGSI EDIT HAFALAN ---
        function prepareEditHafalan(id) {
            const h = db.hafalan.find(item => String(item.id) === String(id));
            if (!h) return;

            state.editingHafalanId = id; // Set Mode Edit
            
            // Pre-fill Form
            const sel = document.getElementById('inputHafalanSantri');
            sel.innerHTML = '';
            const sName = db.students.find(s => s.id == h.studentId)?.name || 'Siswa';
            sel.innerHTML = `<option value="${h.studentId}" selected>${sName}</option>`;
            sel.disabled = true; // Tidak boleh ganti siswa saat edit

            document.getElementById('inputHafalanSurah').value = h.surah;
            document.getElementById('inputHafalanNote').value = h.note;
            document.getElementById('btnSaveHafalan').innerText = "Update Data";

            document.getElementById('hafalanModal').classList.remove('hidden');
        }

        function saveHafalan() {
            const sId = document.getElementById('inputHafalanSantri').value;
            const surah = document.getElementById('inputHafalanSurah').value;
            const note = document.getElementById('inputHafalanNote').value;

            if (!surah) return alert('Isi surah/pencapaian!');

            if (state.editingHafalanId) {
                // --- MODE UPDATE ---
                const index = db.hafalan.findIndex(h => String(h.id) === String(state.editingHafalanId));
                if (index !== -1) {
                    db.hafalan[index].surah = surah;
                    db.hafalan[index].note = note;
                }

                sendData({
                    action: 'editHafalan',
                    id: state.editingHafalanId,
                    surah: surah,
                    note: note
                });
                state.editingHafalanId = null; // Reset
                document.getElementById('inputHafalanSantri').disabled = false;
            } else {
                // --- MODE BARU ---
                const newId = 'haf_' + Date.now();
                const newEntry = {
                    id: newId,
                    studentId: sId,
                    date: state.selectedDate,
                    surah: surah,
                    note: note
                };
                db.hafalan.push(newEntry);
                
                sendData({
                    action: 'addHafalan',
                    ...newEntry
                });
            }

            closeHafalanModal();
            renderHafalan();
            
            Swal.fire({
                icon: 'success',
                title: 'Berhasil!',
                text: 'Data hafalan tersimpan.',
                timer: 1500,
                showConfirmButton: false
            });
        }

        function delHaf(id) {
            Swal.fire({
                title: 'Hapus Hafalan?',
                text: "Data yang dihapus tidak bisa dikembalikan!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#d1d5db',
                confirmButtonText: 'Ya, Hapus!'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Update Local
                    db.hafalan = db.hafalan.filter(h => String(h.id) !== String(id));
                    renderHafalan();
                    
                    // Send to Server
                    sendData({
                        action: 'deleteHafalan',
                        id: id
                    });

                    Swal.fire(
                        'Terhapus!',
                        'Data hafalan telah dihapus.',
                        'success'
                    )
                }
            })
        }

        // --- MATERI LOGIC ---

        function renderMateri() {
            const list = document.getElementById('materiList');
            list.innerHTML = '';
            const data = db.materi.filter(m => m.classId === state.currentClassId);

            if(data.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-400 py-8">Belum ada jurnal materi.</p>`;
                return;
            }

            data.forEach(m => {
                list.innerHTML += `
                    <div class="bg-white p-4 rounded-xl border-l-4 border-blue-500 shadow-sm">
                        <div class="flex justify-between">
                            <h4 class="font-bold text-gray-800">${m.title}</h4>
                            <span class="text-xs text-gray-400">${m.date}</span>
                        </div>
                        <p class="text-gray-600 mt-2 text-sm">${m.desc}</p>
                    </div>
                `;
            });
        }

        function saveMateri() {
            const title = document.getElementById('inputMateriJudul').value;
            const desc = document.getElementById('inputMateriDesc').value;
            
            if(!title) return;

            const newMateri = {
                id: 'mat_' + Date.now(),
                classId: state.currentClassId,
                date: state.selectedDate,
                title: title,
                desc: desc
            };

            db.materi.unshift(newMateri); // Add to top
            renderMateri();
            document.getElementById('materiModal').classList.add('hidden');

            sendData({
                action: 'addMateri',
                ...newMateri
            });
        }

        // --- DATA SYNC & UTILS ---

        function sendData(payload) {
            if (!navigator.onLine) {
                // Queue logic could go here
                console.warn('Offline: Data saved locally only');
                localStorage.setItem('pesantrenDB_v6_pro', JSON.stringify(db));
                return;
            }

            // Show Mini Loader
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.innerHTML = '<i class="fas fa-sync fa-spin text-blue-500"></i> Syncing...';

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                console.log('Server Response:', data);
                if(data.status === 'success') {
                    syncStatus.innerHTML = '<i class="fas fa-check text-green-500"></i> Saved';
                    setTimeout(() => updateStatus(true), 2000);
                } else {
                    syncStatus.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500"></i> Error';
                }
            })
            .catch(err => {
                console.error('Send Error:', err);
                syncStatus.innerHTML = '<i class="fas fa-wifi text-red-500"></i> Offline';
            });
            
            // Always save local backup
            localStorage.setItem('pesantrenDB_v6_pro', JSON.stringify(db));
        }

        function updateStatus(isOnline) {
            state.isOnline = isOnline;
            const el = document.getElementById('syncStatus');
            if(isOnline) el.innerHTML = '<i class="fas fa-circle text-green-500 mr-1"></i> Online';
            else el.innerHTML = '<i class="fas fa-wifi text-red-500 mr-1"></i> Offline';
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
        }

        function saveMasterData() {
            try {
                const raw = document.getElementById('jsonInput').value;
                const parsed = JSON.parse(raw);
                if(parsed.classes && parsed.students) {
                    // Update Local
                    db.classes = parsed.classes;
                    db.students = parsed.students;
                    localStorage.setItem('pesantrenDB_v6_pro', JSON.stringify(db));
                    
                    // Send to Server
                    sendData({
                        action: 'syncMaster',
                        classes: parsed.classes,
                        students: parsed.students
                    });
                    
                    alert('Master Data Updated!');
                } else {
                    alert('Invalid JSON Format');
                }
            } catch(e) {
                alert('Error Parsing JSON: ' + e.message);
            }
        }
    </script>
</body>
</html>
