<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Madrasah Diniyyah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        islamic: {
                            50: '#f0fdf4', 100: '#dcfce7', 500: '#22c55e', 
                            600: '#16a34a', 800: '#166534', 900: '#14532d',
                        }
                    },
                    fontFamily: { sans: ['Poppins', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #16a34a; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col overflow-hidden">

    <div id="loadingOverlay" class="loading-overlay">
        <div class="bg-white p-5 rounded-lg flex flex-col items-center">
            <div class="spinner mb-3"></div>
            <p class="font-semibold text-islamic-800">Memproses...</p>
        </div>
    </div>

    <div id="loginScreen" class="fixed inset-0 z-50 bg-islamic-900 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md text-center">
            <div class="w-20 h-20 bg-islamic-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-mosque text-4xl text-islamic-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Madrasah Diniyyah</h2>
            <p class="text-gray-500 mb-8">Silahkan login untuk mengakses sistem</p>
            <input type="password" id="passwordInput" placeholder="Masukkan Password Ustadz" 
                class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-islamic-500 focus:outline-none mb-4 transition-all">
            <button onclick="handleLogin()" 
                class="w-full bg-islamic-600 hover:bg-islamic-700 text-white font-semibold py-3 rounded-xl transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                Masuk Sistem
            </button>
        </div>
    </div>

    <div id="mainApp" class="flex-1 flex flex-col hidden h-full">
        <header class="bg-white shadow-sm border-b px-6 py-4 flex justify-between items-center z-10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-islamic-600 rounded-lg flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-quran"></i>
                </div>
                <div>
                    <h1 class="font-bold text-gray-800 leading-tight">Admin Madrasah</h1>
                    <p class="text-xs text-gray-500">Panel Ustadz</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <select id="classSelector" onchange="renderUI()" class="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-islamic-500 focus:border-islamic-500 block p-2">
                    </select>
                <button onclick="refreshData()" class="p-2 text-gray-400 hover:text-islamic-600 transition-colors" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </header>

        <div class="bg-white border-b px-6">
            <div class="flex gap-6 overflow-x-auto no-scrollbar">
                <button onclick="switchTab('absensi')" id="tab-absensi" class="tab-btn active-tab py-4 text-sm font-medium border-b-2 border-islamic-600 text-islamic-700">
                    <i class="fas fa-user-check mr-2"></i>Absensi
                </button>
                <button onclick="switchTab('hafalan')" id="tab-hafalan" class="tab-btn py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    <i class="fas fa-book-open mr-2"></i>Hafalan
                </button>
                <button onclick="switchTab('materi')" id="tab-materi" class="tab-btn py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    <i class="fas fa-chalkboard-teacher mr-2"></i>Materi
                </button>
                <button onclick="switchTab('siswa')" id="tab-siswa" class="tab-btn py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    <i class="fas fa-users mr-2"></i>Data Santri
                </button>
            </div>
        </div>

        <main class="flex-1 overflow-y-auto bg-gray-50 p-4 sm:p-6 relative">
            
            <div id="content-absensi" class="tab-content max-w-5xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-gray-800">Input Absensi Harian</h2>
                    <input type="date" id="attendanceDate" class="border rounded-lg px-3 py-1.5 text-sm bg-white shadow-sm" onchange="renderAttendanceList()">
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="px-6 py-3 text-xs font-bold text-gray-500 uppercase">Nama Santri</th>
                                <th class="px-6 py-3 text-xs font-bold text-gray-500 uppercase text-center">Status Kehadiran</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceList" class="divide-y divide-gray-100">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="content-hafalan" class="tab-content hidden max-w-5xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-xl shadow-sm border p-5 sticky top-6">
                            <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Input Hafalan</h3>
                            <input type="hidden" id="hafalanId"> <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Santri</label>
                                    <select id="hafalanStudent" class="w-full p-2 border rounded-lg text-sm bg-gray-50 focus:ring-1 focus:ring-islamic-500"></select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Tanggal</label>
                                    <input type="date" id="hafalanDate" class="w-full p-2 border rounded-lg text-sm bg-gray-50">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Surah / Ayat</label>
                                    <input type="text" id="hafalanSurah" placeholder="Cth: An-Naba 1-10" class="w-full p-2 border rounded-lg text-sm bg-gray-50">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Catatan / Nilai</label>
                                    <textarea id="hafalanNote" rows="2" placeholder="Lancar / Perlu diulang" class="w-full p-2 border rounded-lg text-sm bg-gray-50"></textarea>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="submitHafalan()" id="btnSaveHafalan" class="flex-1 bg-islamic-600 hover:bg-islamic-700 text-white py-2 rounded-lg text-sm font-medium transition shadow-sm">
                                        Simpan
                                    </button>
                                    <button onclick="resetHafalanForm()" id="btnCancelHafalan" class="hidden px-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm">
                                        Batal
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                            <div class="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
                                <h3 class="font-bold text-gray-700 text-sm">Riwayat Setoran (Terbaru)</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                                        <tr>
                                            <th class="px-4 py-3">Tgl</th>
                                            <th class="px-4 py-3">Santri</th>
                                            <th class="px-4 py-3">Hafalan</th>
                                            <th class="px-4 py-3">Ket</th>
                                            <th class="px-4 py-3 text-center">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="hafalanHistory" class="divide-y divide-gray-100">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-materi" class="tab-content hidden max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                    <h3 class="font-bold text-gray-800 mb-4">Jurnal Materi Kelas</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input type="date" id="materiDate" class="p-2 border rounded-lg text-sm">
                        <input type="text" id="materiTitle" placeholder="Judul Materi (Cth: Fiqih Bab Wudhu)" class="p-2 border rounded-lg text-sm">
                    </div>
                    <textarea id="materiDesc" rows="3" placeholder="Ringkasan materi yang diajarkan..." class="w-full p-2 border rounded-lg text-sm mb-4"></textarea>
                    <button onclick="submitMateri()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-sm w-full md:w-auto">
                        <i class="fas fa-plus-circle mr-2"></i>Catat Materi
                    </button>
                </div>

                <div class="space-y-4" id="materiList">
                    </div>
            </div>

            <div id="content-siswa" class="tab-content hidden max-w-5xl mx-auto">
                 <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                            <tr>
                                <th class="px-6 py-3">ID</th>
                                <th class="px-6 py-3">Nama Santri</th>
                                <th class="px-6 py-3 text-center">Hadir</th>
                                <th class="px-6 py-3 text-center">Izin</th>
                                <th class="px-6 py-3 text-center">Alpha</th>
                            </tr>
                        </thead>
                        <tbody id="studentList" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- KONFIGURASI ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx3L878q7KDR8nDVVhbibNEIIAlrHfOHI9-9wrP2PEN1KG1g2RPxTLw61zYIpVkdlwWCA/exec'; // URL Deployment GAS 
        
        // --- STATE ---
        let db = { classes: [], students: [], attendanceRecap: {}, materi: [], hafalan: [] };
        let activeClassId = null;

        // --- INIT & LOGIN ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedToken = localStorage.getItem('ustadzToken');
            if(savedToken === 'valid') {
                showApp();
            }
        });

        function handleLogin() {
            const pass = document.getElementById('passwordInput').value;
            toggleLoading(true);
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'login', password: pass })
            })
            .then(res => res.json())
            .then(data => {
                toggleLoading(false);
                if(data.status === 'success') {
                    localStorage.setItem('ustadzToken', 'valid');
                    showApp();
                } else {
                    alert('Password Salah!');
                }
            })
            .catch(err => {
                toggleLoading(false);
                alert('Gagal Login: ' + err);
            });
        }

        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('flex');
            
            // Set Default Dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
            document.getElementById('hafalanDate').value = today;
            document.getElementById('materiDate').value = today;

            refreshData();
        }

        function toggleLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function generateId(prefix) {
            return prefix + '-' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // --- DATA SYNC ---
        function refreshData() {
            toggleLoading(true);
            fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(resp => {
                if(resp.status === 'success') {
                    db = resp.data;
                    initClassSelector();
                    renderUI();
                } else {
                    alert('Gagal memuat data: ' + resp.message);
                }
            })
            .catch(e => alert('Koneksi Error'))
            .finally(() => toggleLoading(false));
        }

        function initClassSelector() {
            const sel = document.getElementById('classSelector');
            sel.innerHTML = '';
            
            if (db.classes.length === 0) {
                // Dummy Data jika kosong
                db.classes = [{id: '1', name: 'Kelas A'}, {id: '2', name: 'Kelas B'}]; 
            }

            db.classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                sel.appendChild(opt);
            });

            // Restore selection or pick first
            if(!activeClassId && db.classes.length > 0) activeClassId = db.classes[0].id;
            sel.value = activeClassId;
        }

        // --- RENDER UI ---
        function renderUI() {
            activeClassId = document.getElementById('classSelector').value;
            renderAttendanceList();
            renderHafalanForm();
            renderHafalanHistory();
            renderMateriList();
            renderStudentList();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('content-' + tabId).classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-islamic-600', 'text-islamic-700');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            const activeBtn = document.getElementById('tab-' + tabId);
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
            activeBtn.classList.add('border-islamic-600', 'text-islamic-700');
        }

        // --- 1. ABSENSI LOGIC ---
        function renderAttendanceList() {
            const tbody = document.getElementById('attendanceList');
            tbody.innerHTML = '';
            const date = document.getElementById('attendanceDate').value;
            
            const studentsInClass = db.students.filter(s => s.classId == activeClassId);

            studentsInClass.forEach(s => {
                const status = (s.attendance && s.attendance[date]) ? s.attendance[date] : '';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900">${s.name}</td>
                    <td class="px-6 py-4 text-center">
                        <div class="inline-flex bg-gray-100 rounded-lg p-1">
                            ${renderAbsenBtn(s.id, 'H', 'Hadir', 'bg-green-500', status)}
                            ${renderAbsenBtn(s.id, 'I', 'Izin', 'bg-yellow-500', status)}
                            ${renderAbsenBtn(s.id, 'S', 'Sakit', 'bg-blue-500', status)}
                            ${renderAbsenBtn(s.id, 'A', 'Alpha', 'bg-red-500', status)}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderAbsenBtn(sId, val, label, colorClass, currentStatus) {
            const isActive = currentStatus === val;
            const finalClass = isActive ? `text-white ${colorClass} shadow-md` : 'text-gray-500 hover:bg-gray-200';
            return `<button onclick="submitAbsen('${sId}', '${val}')" class="px-3 py-1.5 rounded-md text-xs font-bold transition-all ${finalClass}">${val}</button>`;
        }

        function submitAbsen(sId, status) {
            const date = document.getElementById('attendanceDate').value;
            
            // Optimistic Update (Update Lokal Dulu)
            const sIdx = db.students.findIndex(s => s.id == sId);
            if(!db.students[sIdx].attendance) db.students[sIdx].attendance = {};
            db.students[sIdx].attendance[date] = status;
            renderAttendanceList();

            // Kirim Background
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'updateAttendance', studentId: sId, date: date, status: status })
            });
        }

        // --- 2. HAFALAN LOGIC ---
        function renderHafalanForm() {
            const sel = document.getElementById('hafalanStudent');
            sel.innerHTML = '';
            const studentsInClass = db.students.filter(s => s.classId == activeClassId);
            studentsInClass.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.name;
                sel.appendChild(opt);
            });
        }

        function renderHafalanHistory() {
            const tbody = document.getElementById('hafalanHistory');
            tbody.innerHTML = '';
            
            // Filter Hafalan (Hanya kelas aktif)
            const studentsIds = db.students.filter(s => s.classId == activeClassId).map(s => s.id);
            // Reverse agar yang baru di atas
            const dataHafalan = db.hafalan.filter(h => studentsIds.includes(String(h.studentId))).reverse();

            dataHafalan.forEach(h => {
                const sName = db.students.find(s => s.id == h.studentId)?.name || 'Unknown';
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="px-4 py-3">${h.date}</td>
                    <td class="px-4 py-3 font-medium">${sName}</td>
                    <td class="px-4 py-3">${h.surah}</td>
                    <td class="px-4 py-3 text-gray-500 text-xs italic">${h.note}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="editHafalan('${h.id}')" class="text-blue-500 hover:text-blue-700 mx-1"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteHafalan('${h.id}')" class="text-red-500 hover:text-red-700 mx-1"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function submitHafalan() {
            const id = document.getElementById('hafalanId').value;
            const studentId = document.getElementById('hafalanStudent').value;
            const date = document.getElementById('hafalanDate').value;
            const surah = document.getElementById('hafalanSurah').value;
            const note = document.getElementById('hafalanNote').value;

            if(!surah) return alert('Isi Hafalan dulu');

            toggleLoading(true);
            
            const payload = {
                action: id ? 'editHafalan' : 'addHafalan', // Cek apakah Edit atau Baru
                id: id || generateId('HFL'), // Pakai ID lama atau Buat Baru
                studentId, date, surah, note
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(() => {
                resetHafalanForm();
                refreshData(); // Reload data dari server
            })
            .catch(err => alert('Gagal: ' + err))
            .finally(() => toggleLoading(false));
        }

        function editHafalan(id) {
            const h = db.hafalan.find(x => x.id == id);
            if(!h) return;

            document.getElementById('hafalanId').value = h.id;
            document.getElementById('hafalanStudent').value = h.studentId;
            document.getElementById('hafalanDate').value = h.date; // format yyyy-mm-dd
            document.getElementById('hafalanSurah').value = h.surah;
            document.getElementById('hafalanNote').value = h.note;

            document.getElementById('btnSaveHafalan').textContent = "Update Data";
            document.getElementById('btnSaveHafalan').classList.replace('bg-islamic-600', 'bg-blue-600');
            document.getElementById('btnCancelHafalan').classList.remove('hidden');
        }

        function deleteHafalan(id) {
            if(!confirm('Hapus data hafalan ini?')) return;
            toggleLoading(true);
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'deleteHafalan', id: id })
            }).then(() => refreshData());
        }

        function resetHafalanForm() {
            document.getElementById('hafalanId').value = '';
            document.getElementById('hafalanSurah').value = '';
            document.getElementById('hafalanNote').value = '';
            document.getElementById('btnSaveHafalan').textContent = "Simpan";
            document.getElementById('btnSaveHafalan').classList.replace('bg-blue-600', 'bg-islamic-600');
            document.getElementById('btnCancelHafalan').classList.add('hidden');
        }

        // --- 3. MATERI LOGIC ---
        function renderMateriList() {
            const container = document.getElementById('materiList');
            container.innerHTML = '';
            const materiClass = db.materi.filter(m => m.classId == activeClassId).reverse();

            materiClass.forEach(m => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-lg shadow-sm border border-l-4 border-l-blue-500 relative";
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-xs font-bold text-gray-400 block mb-1">${m.date}</span>
                            <h4 class="font-bold text-gray-800 text-lg">${m.title}</h4>
                            <p class="text-gray-600 mt-2 text-sm">${m.desc}</p>
                        </div>
                        <button onclick="deleteMateri('${m.id}')" class="text-red-400 hover:text-red-600 p-2"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function submitMateri() {
            const date = document.getElementById('materiDate').value;
            const title = document.getElementById('materiTitle').value;
            const desc = document.getElementById('materiDesc').value;

            if(!title) return alert('Isi Judul Materi');
            
            toggleLoading(true);
            const newId = generateId('MAT');

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'addMateri',
                    id: newId,
                    classId: activeClassId,
                    date, title, desc
                })
            }).then(() => {
                document.getElementById('materiTitle').value = '';
                document.getElementById('materiDesc').value = '';
                refreshData();
            });
        }

        function deleteMateri(id) {
            if(!confirm('Hapus materi ini?')) return;
            toggleLoading(true);
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'deleteMateri', id: id })
            }).then(() => refreshData());
        }

        // --- 4. STUDENT LIST (READ ONLY) ---
        function renderStudentList() {
            const tbody = document.getElementById('studentList');
            tbody.innerHTML = '';
            const studentsInClass = db.students.filter(s => s.classId == activeClassId);

            studentsInClass.forEach(s => {
                const recap = db.attendanceRecap[s.id] || {H:0, I:0, S:0, A:0};
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b";
                tr.innerHTML = `
                    <td class="px-6 py-4 font-mono text-xs text-gray-500">${s.id}</td>
                    <td class="px-6 py-4 font-medium text-gray-900">${s.name}</td>
                    <td class="px-6 py-4 text-center text-green-600 font-bold">${recap.H}</td>
                    <td class="px-6 py-4 text-center text-yellow-600 font-bold">${recap.I}</td>
                    <td class="px-6 py-4 text-center text-red-600 font-bold">${recap.A}</td>
                `;
                tbody.appendChild(tr);
            });
        }

    </script>
</body>
</html>
