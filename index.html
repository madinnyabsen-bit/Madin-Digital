<script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbwaEuq8upBodGN4373tFo83b2KCuesSQct7SdWTOhXzfyNMKWKhD7XHfCYLdQEK0AZz/exec";
    let currentUserRole = "ustadz";
    let semuaDataSantri = [];
    let logAbsensi = []; 
    let kelasAktif = "";

    async function loginUstadz() {
        const pw = prompt("Masukkan Password Ustadz/ustadzah:");
        if(!pw) return;
        try {
            const res = await fetch(`${scriptURL}?action=login&pass=${pw}`);
            const result = await res.text();
            if(result === "SUCCESS") {
                currentUserRole = "ustadz";
                lanjutMasuk();
            } else { alert("Password Salah!"); }
        } catch (e) { alert("Error Login!"); }
    }

    function loginWali() { currentUserRole = "wali"; lanjutMasuk(); }

    async function lanjutMasuk() {
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('pilih-kelas-page').classList.remove('hidden');
        loadMotivasi();
        loadDaftarKelas();
        await loadDataSantri();
        await loadLogAbsensi(); 
    }

    async function loadMotivasi() {
        const hari = ["MINGGU", "SENIN", "SELASA", "RABU", "KAMIS", "JUMAT", "SABTU"];
        try {
            const res = await fetch(scriptURL + "?action=readMotivasi");
            const data = await res.json();
            const motiv = data.find(m => m[0].toUpperCase() === hari[new Date().getDay()]);
            document.getElementById('box-motivasi').innerText = motiv ? motiv[1] : "Semangat Mengaji!";
        } catch (e) { }
    }

    async function loadDaftarKelas() {
        const res = await fetch(scriptURL + "?action=readKelas");
        const list = await res.json();
        document.getElementById('grid-kelas-otomatis').innerHTML = list.map(k => 
            `<button style="background:var(--dark-bar); color:white; border:none; padding:18px; border-radius:12px; font-weight:800; font-size:0.75rem;" onclick="bukaAbsensi('${encodeURIComponent(k)}')">${k}</button>`
        ).join('');
    }

    async function loadDataSantri() {
        const res = await fetch(scriptURL + "?action=read");
        const data = await res.json();
        semuaDataSantri = data.map(r => ({ nama: r[1].toString().trim(), kelas: r[2].toString().trim(), status: "", surat: "-", ket: "-", catatan: "-" }));
    }

    async function loadLogAbsensi() {
        const res = await fetch(scriptURL + "?action=readAbsensi");
        logAbsensi = await res.json(); 
        sinkronisasiStatus();
    }

    // --- PERBAIKAN: SINKRONISASI TANGGAL LEBIH AKURAT ---
    function sinkronisasiStatus() {
        const tglPilihan = document.getElementById('input-tanggal').value;
        if(!tglPilihan) return;
        
        semuaDataSantri.forEach(s => {
            const found = logAbsensi.find(row => {
                if(!row[1]) return false;
                // Ambil 10 karakter pertama (YYYY-MM-DD) agar tidak terganggu format waktu
                let tglRow = row[1].toString().substring(0, 10);
                return tglRow === tglPilihan && row[3].toString().trim().toLowerCase() === s.nama.toLowerCase();
            });
            s.status = found ? found[4] : ""; 
        });
        if(kelasAktif) renderSantri();
    }

    function bukaAbsensi(encodedK) {
        kelasAktif = decodeURIComponent(encodedK);
        document.getElementById('judul-kelas-aktif').innerText = kelasAktif;
        document.getElementById('pilih-kelas-page').classList.add('hidden');
        document.getElementById('absensi-page').classList.remove('hidden');
        sinkronisasiStatus();
    }

    function renderSantri() {
        const filtered = semuaDataSantri.filter(s => s.kelas === kelasAktif);
        document.getElementById('list-santri').innerHTML = filtered.map(s => {
            const isFilled = s.status !== "" ? "sudah-absen" : "";
            const check = s.status !== "" ? "✅ " : "";
            return `
            <div class="santri-item ${isFilled}">
                <button class="name-btn">${check}${s.nama}</button>
                <div class="d-flex gap-1">
                    ${['H','S','I','A'].map(st => `<button class="btn-st ${s.status===st?'active':''}" onclick="updateStatus('${s.nama.replace(/'/g, "\\'")}','${st}')">${st}</button>`).join('')}
                </div>
            </div>`;
        }).join('');
    }

    function updateStatus(n, st) {
        if(currentUserRole !== 'ustadz') return;
        const santri = semuaDataSantri.find(s => s.nama === n);
        if(santri) { 
            santri.status = (santri.status === st) ? "" : st; 
            renderSantri(); 
        }
    }

    async function tambahSantri() {
        if(currentUserRole !== 'ustadz') return;
        const namaBaru = prompt("Masukkan Nama Santri Baru:");
        if(!namaBaru) return;
        
        const nUpper = namaBaru.toUpperCase().trim();
        semuaDataSantri.push({
            nama: nUpper,
            kelas: kelasAktif,
            status: "",
            surat: "-",
            ket: "-",
            catatan: "-"
        });
        
        renderSantri();
        
        try {
            await fetch(`${scriptURL}?action=tambahSantri&nama=${encodeURIComponent(nUpper)}&kelas=${encodeURIComponent(kelasAktif)}`);
        } catch(e) { console.log("Database sync failed"); }
    }

    // --- PERBAIKAN: PROSES SIMPAN HARUS REFRESH LOG ---
    async function simpanAbsen() {
        if(currentUserRole !== 'ustadz') return;
        const tgl = document.getElementById('input-tanggal').value;
        const btn = document.getElementById('btn-save-absen');
        const filtered = semuaDataSantri.filter(s => s.kelas === kelasAktif && s.status !== "");
        
        if(!filtered.length) return alert("Pilih status absen dulu!");
        
        btn.disabled = true; btn.innerText = "MENYIMPAN...";
        try {
            for(let s of filtered) { 
                await fetch(`${scriptURL}?action=absen&tanggal=${tgl}&kelas=${encodeURIComponent(kelasAktif)}&nama=${encodeURIComponent(s.nama)}&status=${s.status}`); 
            }
            alert("Berhasil Tersimpan!");
            // Refresh log agar tanda ✅ muncul dan perhitungan rekap update
            await loadLogAbsensi(); 
        } catch(e) { alert("Gagal Simpan!"); }
        btn.disabled = false; btn.innerText = "KONFIRMASI ABSENSI";
    }

    function gantiTab(tab) {
        document.querySelectorAll('.nav-link-custom').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        document.getElementById('konten-absensi').classList.toggle('hidden', tab !== 'absensi');
        document.getElementById('konten-hafalan').classList.toggle('hidden', tab !== 'hafalan');
        if(tab === 'hafalan') renderHafalan();
    }

    function renderHafalan() {
        const filtered = semuaDataSantri.filter(s => s.kelas === kelasAktif);
        document.getElementById('list-hafalan').innerHTML = filtered.map(s => `
            <tr>
                <td style="text-align:left; font-weight:800; color:var(--madin-green)">${s.nama}</td>
                <td onclick="editHafalan('${s.nama.replace(/'/g, "\\'")}','surat')">${s.surat}</td>
                <td onclick="editHafalan('${s.nama.replace(/'/g, "\\'")}','ket')">${s.ket}</td>
                <td onclick="editHafalan('${s.nama.replace(/'/g, "\\'")}','catatan')">${s.catatan}</td>
            </tr>`).join('');
    }

    function editHafalan(n, f) {
        if(currentUserRole !== 'ustadz') return;
        const s = semuaDataSantri.find(x => x.nama.toString().trim() === n.toString().trim());
        if(!s) return;
        const v = prompt(`Edit ${f.toUpperCase()}:`, s[f]);
        if(v !== null) { 
            s[f] = v.toUpperCase() || "-"; 
            renderHafalan(); 
        }
    }

    async function simpanHafalan() {
        if(currentUserRole !== 'ustadz') return;
        const tgl = document.getElementById('input-tanggal').value;
        const filtered = semuaDataSantri.filter(s => s.kelas === kelasAktif && s.surat !== "-");
        const btn = document.getElementById('btn-save-hafalan');
        btn.disabled = true; btn.innerText = "MEMPROSES...";
        try {
            for(let s of filtered) { 
                await fetch(`${scriptURL}?action=simpanHafalan&tanggal=${tgl}&kelas=${encodeURIComponent(kelasAktif)}&nama=${encodeURIComponent(s.nama)}&surat=${s.surat}&ket=${s.ket}&catatan=${s.catatan}`); 
            }
            alert("Hafalan Berhasil Dicatat!");
        } catch(e) { }
        btn.disabled = false; btn.innerText = "KONFIRMASI HAFALAN";
    }

    function bukaModalRekap() {
        document.getElementById('rekap-modal').classList.remove('hidden');
        const filtered = semuaDataSantri.filter(s => s.kelas === kelasAktif);
        document.getElementById('isi-rekap').innerHTML = filtered.map(s => {
            const hists = logAbsensi.filter(row => row[3].toString().trim().toLowerCase() === s.nama.toLowerCase());
            return `<div class="card-rekap"><b>${s.nama}</b><br><small>H:${hists.filter(r=>r[4]==='H').length} S:${hists.filter(r=>r[4]==='S').length} I:${hists.filter(r=>r[4]==='I').length} A:${hists.filter(r=>r[4]==='A').length}</small></div>`;
        }).join('');
    }

    function tutupModalRekap() { document.getElementById('rekap-modal').classList.add('hidden'); }
    function backToKelas() { document.getElementById('absensi-page').classList.add('hidden'); document.getElementById('pilih-kelas-page').classList.remove('hidden'); }
    function logout() { location.reload(); }
    
    setInterval(() => { 
        document.querySelectorAll('.live-jam').forEach(el => el.innerText = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) + " WIB"); 
    }, 1000);

    window.onload = () => { 
        document.getElementById('input-tanggal').value = new Date().toISOString().split('T')[0]; 
    };
</script>
